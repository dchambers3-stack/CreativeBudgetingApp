<div class="container py-5">
  @let data = dashboardInfo.value();
  <h2 class="mb-4 fw-bold" style="color: var(--primary-color)">
    {{ "dashboard.greeting" | translate }},
    {{ data?.firstName ? data?.firstName : ("common.friend" | translate) }}!
    {{ "dashboard.welcomeMessage" | translate }} {{ currentMonthName() }}
    {{ "dashboard.budget" | translate }}.
  </h2>

  <div class="mb-5 d-flex gap-3">
    <button
      (click)="
        data?.firstName ? navigateToPaycheck() : navigateToPersonalInfo()
      "
      class="btn btn-gradient-green px-4 py-2"
    >
      <i class="fas fa-user me-2"></i>
      {{
        data?.firstName
          ? ("dashboard.enterPayInfo" | translate)
          : ("dashboard.enterPersonalInfo" | translate)
      }}
    </button>
    <button
      (click)="navigateToAddExpenses()"
      class="btn btn-gradient-gray px-4 py-2"
    >
      <i class="fas fa-plus me-2"></i>
      {{ "dashboard.enterExpenses" | translate }}
    </button>
  </div>

  @if (showAlert()) {
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>{{ "common.warning" | translate }}!</strong>
    {{ "dashboard.cannotDeletePaycheck" | translate }}
    <button
      type="button"
      class="btn-close"
      (click)="showAlert.set(false)"
    ></button>
  </div>
  } @let pcks = paychecksInfo.value();
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card border-primary shadow pay-info-card">
        <div class="card-header text-white">
          {{ "dashboard.payInformation" | translate }}
        </div>
        <div class="card-body">
          @if (pcks?.length) { @for (paycheck of pcks; track $index) {
          <div
            class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded"
          >
            <div>
              <strong>
                {{ "dashboard.paycheck" | translate }} {{ $index + 1 }}:
                {{ paycheck.amount | currency }} ({{
                  paycheck.payDate | date : "MMM d, yyyy"
                }})
              </strong>
            </div>
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-gradient-red"
                (click)="handleDeletePaycheck(paycheck)"
                [title]="'dashboard.deletePaycheck' | translate"
              >
                <i class="fas fa-trash"></i>
              </button>
              <button
                class="btn btn-sm btn-outline-success"
                (click)="openEditModal(paycheck.id)"
                data-bs-toggle="modal"
                data-bs-target="#paycheckModal"
                [title]="'dashboard.editPaycheck' | translate"
              >
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
          } } @else {
          <p class="text-muted">{{ "dashboard.noPaycheckData" | translate }}</p>
          }
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-light shadow bg-body-tertiary">
        <div class="card-header bg-light">
          {{ "dashboard.budgetSummary" | translate }}
        </div>
        <div class="card-body">
          <p class="mb-2">
            <strong
              >{{ "dashboard.totalIncome" | translate }}:
              {{ totalIncome() | currency }}</strong
            >
          </p>
          <p class="mb-2">
            <strong
              >{{ "dashboard.totalExpenses" | translate }}:
              {{ totalExpenses() | currency }}</strong
            >
          </p>
          <div class="mb-2">
            <small class="text-muted">
              <span class="text-success"
                >{{ "dashboard.paid" | translate }}:
                {{ totalPaidExpenses() | currency }}</span
              >
              |
              <span class="text-warning"
                >{{ "dashboard.unpaid" | translate }}:
                {{ totalUnpaidExpenses() | currency }}</span
              >
            </small>
          </div>
          @if (remainingBudget() >= 0) {
          <p class="mb-0 text-success">
            <strong
              >{{ "dashboard.remainingBudget" | translate }}:
              {{ remainingBudget() | currency }}</strong
            >
          </p>
          } @else {
          <p class="mb-0 text-danger">
            <strong
              >{{ "dashboard.overBudget" | translate }}:
              {{ remainingBudget() | currency }}</strong
            >
          </p>
          }
        </div>
      </div>
    </div>
  </div>
  @let savings = this.savings.value();
  <!-- Savings Form Card -->
  <div class="card border-primary shadow mt-5 savings-card">
    <div class="card-header text-white">
      {{ "dashboard.manageYourSavings" | translate }}
    </div>
    <div class="card-body">
      <!-- Deduct Savings -->
      <form
        [formGroup]="deductSavingsAmount"
        (ngSubmit)="deductSavings()"
        class="row g-3 align-items-end"
      >
        <div class="col-sm-8">
          <label for="deductSavingsInput" class="form-label fw-bold">
            {{ "dashboard.amountToDeduct" | translate }}
          </label>
          <input
            type="number"
            id="deductSavingsInput"
            formControlName="amount"
            class="form-control"
            [placeholder]="'dashboard.enterAmount' | translate"
            step="0.01"
          />
        </div>
        <div class="col-sm-4">
          <button
            type="submit"
            class="btn btn-danger w-100"
            [disabled]="deductSavingsAmount.invalid || isLoading()"
          >
            <i class="fas fa-piggy-bank me-2"></i>
            {{
              isLoading()
                ? ("common.loading" | translate)
                : ("dashboard.deduct" | translate)
            }}
          </button>
        </div>
      </form>

      <!-- Balance -->
      <h5 class="mt-4">
        {{ "dashboard.savingsBalance" | translate }}:
        <span class="text-success">{{ savings?.amount ?? 0 | currency }}</span>
      </h5>
    </div>
  </div>

  <!-- Set up back end for this.  Need to add a table -->

  @let expenseGroups = this.expensesSortedByPaycheck(); @if
  (expenseGroups?.length) {
  <div class="accordion mt-5" id="expenseAccordion">
    <h4 class="mb-3">{{ "dashboard.expenses" | translate }}:</h4>
    @for (group of expenseGroups; track group.paycheckId) {
    <div class="accordion-item">
      <h2
        class="accordion-header"
        id="paycheckHeading{{ group.paycheckId || 'none' }}"
      >
        <button
          class="accordion-button collapsed d-flex align-items-center w-100"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="
            '#paycheckCollapse' + (group.paycheckId || 'none')
          "
          aria-expanded="false"
          [attr.aria-controls]="
            'paycheckCollapse' + (group.paycheckId || 'none')
          "
        >
          <div class="d-flex justify-content-between align-items-center w-100">
            <div class="d-flex flex-column">
              <span class="flex-grow-1">
                {{ group.paycheckLabel }}
              </span>
              <span>
                {{ "dashboard.expenseCount" | translate }}:
                {{ group.expenses.length }}
              </span>
            </div>
            @if (group.paycheckId !== null) {
            <div class="d-flex flex-column text-end me-3">
              <span class="fw-bold">
                {{ "dashboard.remainingBudget" | translate }}:
                <span
                  [class]="
                    group.remainingBudget >= 0 ? 'text-success' : 'text-danger'
                  "
                >
                  {{ group.remainingBudget | currency }}
                </span>
              </span>
              <small class="text-muted">
                {{ group.paycheckAmount | currency }} -
                {{ group.totalExpenses | currency }}
              </small>
            </div>
            }
          </div>
        </button>
      </h2>
      <div
        id="paycheckCollapse{{ group.paycheckId || 'none' }}"
        class="accordion-collapse collapse"
        [attr.aria-labelledby]="
          'paycheckHeading' + (group.paycheckId || 'none')
        "
        data-bs-parent="#expenseAccordion"
      >
        <div class="accordion-body">
          @for (expense of group.expenses; track expense.id) {
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="card-title">{{ expense.name }}</h6>
                  <p class="card-text">
                    <strong
                      >{{ "dashboard.expenseAmount" | translate }}:</strong
                    >
                    {{ expense.payment | currency }}<br />
                    <strong>{{ "dashboard.dueDate" | translate }}:</strong>
                    {{ expense.dueDate | date : "shortDate" }}<br />
                    <strong>{{ "dashboard.category" | translate }}:</strong>
                    {{ expense.categoryName }}<br />
                    <strong>{{ "dashboard.subcategory" | translate }}:</strong>
                    {{ expense.subcategoryName }}<br />
                    <strong>{{ "dashboard.paidStatus" | translate }}:</strong>
                    <span
                      [class]="expense.isPaid ? 'text-success' : 'text-danger'"
                    >
                      {{
                        expense.isPaid
                          ? ("dashboard.paid" | translate)
                          : ("dashboard.unpaid" | translate)
                      }}
                    </span>
                  </p>
                </div>
                <div class="d-flex gap-2">
                  @if(expense.categoryId != 10) {
                  <button
                    type="button"
                    class="btn btn-sm btn-gradient-green"
                    [title]="
                      expense.isPaid
                        ? ('dashboard.expensePaid' | translate)
                        : ('dashboard.markAsPaid' | translate)
                    "
                    (click)="markExpenseAsPaid(expense.id)"
                    [disabled]="expense.isPaid"
                  >
                    <i class="fas fa-dollar-sign me-1"></i>
                    {{
                      expense.isPaid
                        ? ("dashboard.paid" | translate)
                        : ("dashboard.markAsPaid" | translate)
                    }}
                  </button>
                  }
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    (click)="openDeleteExpenseModal(expense.id)"
                    [title]="'dashboard.deleteExpense' | translate"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>
  } @else {
  <!-- No Expenses Placeholder -->
  <div class="text-center py-5 mt-5">
    <div class="card border-0 shadow-sm bg-light">
      <div class="card-body py-5">
        <div class="mb-4">
          <i class="fas fa-receipt fa-4x text-muted opacity-50"></i>
        </div>
        <h4 class="text-muted mb-3">
          {{ "dashboard.noExpensesTitle" | translate }}
        </h4>
        <p class="text-muted mb-4">
          {{ "dashboard.noExpensesMessage" | translate }}
        </p>
        <button
          (click)="navigateToAddExpenses()"
          class="btn btn-gradient-green px-4 py-2"
        >
          <i class="fas fa-plus me-2"></i>
          {{ "dashboard.addFirstExpense" | translate }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Paycheck Edit Modal -->
  <div
    class="modal fade"
    id="paycheckModal"
    tabindex="-1"
    aria-labelledby="paycheckModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="paycheckModalLabel">
            {{ "dashboard.editPaycheckAmount" | translate }}
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="editPay()">
            <div class="mb-3">
              <label for="paycheckAmount" class="form-label">{{
                "dashboard.newPaycheckAmount" | translate
              }}</label>
              <input
                type="number"
                class="form-control"
                id="paycheckAmount"
                [(ngModel)]="modalPayAmount"
                name="paycheckAmount"
                step="0.01"
                required
              />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                {{ "common.cancel" | translate }}
              </button>
              <button
                type="submit"
                class="btn btn-gradient-green"
                data-bs-dismiss="modal"
              >
                {{ "dashboard.saveChanges" | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Paycheck Modal -->
  <div
    class="modal fade"
    id="deletePaycheckModal"
    tabindex="-1"
    aria-labelledby="deletePaycheckModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deletePaycheckModalLabel">
            {{ "dashboard.confirmDeletion" | translate }}
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          {{ "dashboard.deletePaycheckConfirmation" | translate }}
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            {{ "common.cancel" | translate }}
          </button>
          <button
            type="button"
            class="btn btn-gradient-red"
            (click)="deletePaycheckConfirm()"
            data-bs-dismiss="modal"
          >
            {{ "dashboard.confirmDelete" | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Expense Modal -->
  <div
    class="modal fade"
    id="deleteExpenseModal"
    tabindex="-1"
    aria-labelledby="deleteExpenseModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteExpenseModalLabel">
            {{ "dashboard.confirmDeletion" | translate }}
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          @if (selectedExpense?.categoryId != 10) {
          {{
            "dashboard.deleteExpenseConfirmation"
              | translate : { expenseName: selectedExpense?.name }
          }}
          } @else {
          {{ "dashboard.deleteSavingsExpenseWarning" | translate }}
          }
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            {{ "common.cancel" | translate }}
          </button>
          <button
            type="button"
            class="btn btn-gradient-red"
            (click)="deleteExpenseConfirm()"
            data-bs-dismiss="modal"
          >
            {{ "dashboard.confirmDelete" | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
